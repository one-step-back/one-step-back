import{j as a}from"../util/alert.min.js";import{S as l}from"../util/toast.min.js";import{C as $}from"../util/confirm.min.js";a(()=>{const b=window.IMP,y=a(".mypage-wrapper").data("portone-id"),C=a("body").data("member-id");y&&b.init(y);let r=null,m=null,d=[];a(document).on("click",".btn-change-payment",function(){const t=a(this);r=t.data("id"),m=t.data("current-payment");const s=t.data("artist");a("#paymentChangeModal h3").text(`결제 수단 변경 (${s})`),a("#paymentChangeModal").fadeIn(200),v()}),a(document).on("click",".btn-close-modal, .modal-overlay",function(t){(t.target===this||a(this).hasClass("btn-close-modal")||a(this).parent().hasClass("btn-close-modal"))&&(a("#paymentChangeModal").fadeOut(200),r=null,m=null)});function v(){a.ajax({url:"/api/v1/payments",type:"GET",success:t=>{d=t.data||[],h(d),g(d.length)},error:t=>{console.error("Failed to load payments:",t),a("#modal-payment-list").html('<p class="text-center">결제 수단을 불러오지 못했습니다.</p>')}})}function h(t){if(!t||t.length===0){a("#modal-payment-list").html(`
                <div class="empty-card-state">
                    <i class="far fa-credit-card"></i>
                    <p>등록된 카드가 없습니다.</p>
                </div>
            `);return}let s="";t.forEach(e=>{const n=e.default===!0||e.default===1,o=e.id===m;let i="";n&&(i+='<span class="badge-mini">기본</span>'),o&&(i+='<span class="badge-mini current">현재 사용 중</span>');const c=o?'<button type="button" class="btn-select disabled" disabled>사용 중</button>':`<button type="button" class="btn-select" onclick="selectPaymentMethod(${e.id}, '${e.cardName}', '${e.last4Digit}')">선택</button>`;s+=`
                <div class="modal-card-item ${o?"current-item":""}">
                    <div class="card-left">
                        <div class="card-icon-box"><i class="fas fa-credit-card"></i></div>
                        <div class="card-texts">
                            <span class="card-name">${e.cardName} ${i}</span>
                            <span class="card-num">**** **** **** ${e.last4Digit}</span>
                        </div>
                    </div>
                    <div class="card-right">
                        ${c}
                    </div>
                </div>
            `}),a("#modal-payment-list").html(s)}function g(t){let s="";t<3?s=`
                <button type="button" id="btnModalRegisterCard" class="btn-modal-add">
                    <i class="fas fa-plus"></i> 새 카드 등록하기
                </button>`:s='<p class="modal-alert-msg"><i class="fas fa-info-circle"></i> 결제 수단은 최대 3개까지 등록 가능합니다.</p>',a("#modal-action-container").html(s)}a(document).on("click","#btnModalRegisterCard",()=>{const t=crypto.randomUUID();b.request_pay({pg:"tosspayments",pay_method:"card",merchant_uid:`reg_${t}`,customer_uid:`member_${C}_${t}`,name:"결제 수단 등록",amount:0},s=>{if(s.success){const e={billingKey:s.customer_uid,cardName:s.card_name};a.ajax({url:"/api/v1/payments/method",type:"POST",contentType:"application/json",data:JSON.stringify(e),success:n=>{l.success("새 카드가 등록되었습니다."),n.data&&d.push(n.data),h(d),g(d.length)},error:n=>l.error("등록 실패: "+(n.responseText||"오류 발생"))})}else{let e="인증 실패";s.error_msg&&s.error_msg.includes("CANCELED")&&(e="등록 취소"),l.error(e)}})}),window.selectPaymentMethod=function(t,s,e){r&&$.open({title:"결제 수단 변경",desc:`[${s}] 카드로 결제 수단을 변경하시겠습니까?`,actionText:"변경하기",onConfirm:()=>{a.ajax({url:`/api/v1/subscription/${r}/payment-method?paymentMethodId=${t}`,type:"PATCH",success:()=>{l.success("결제 수단이 변경되었습니다.");const n=a(`#sub-card-${r}`),o=n.find(".payment-display"),i=n.find(".btn-change-payment");n.find(".warning-row").remove(),o.find(".payment-warning-text").remove();const c=`
                            <span class="payment-info-text">
                                <i class="far fa-credit-card"></i>
                                <span class="card-name">${s}</span>
                                <span class="card-last4">(${e})</span>
                            </span>
                        `;o.find(".payment-info-text").length>0?o.find(".payment-info-text").replaceWith(c):o.html(c),i.data("current-payment",t),a("#paymentChangeModal").fadeOut(200)},error:n=>{l.error("변경 실패: "+(n.responseText||"오류 발생"))}})}})},a(document).on("click",".btn-toggle-renewal",function(){const t=a(this),e=t.closest(".subscription-card").find(".renewal-status"),n=t.data("id"),o=t.data("artist"),i=t.data("status"),c=!i;let u,p,f;c?(u="구독 유지",p=`[${o}] 님의 멤버십 혜택을 다시 유지하시겠습니까?
다음 결제일에 자동으로 갱신됩니다.`,f="멤버십 유지"):(u="구독 해지 예약",p=`정말로 [${o}] 님의 구독을 해지하시겠습니까?
해지하더라도 다음 결제일까지 혜택은 유지됩니다.`,f="해지 예약"),$.open({title:u,desc:p,actionText:f,onConfirm:()=>{t.data("status",c),c?(t.text("구독 취소").removeClass("btn-resume").addClass("btn-cancel"),e.slideUp(200),l.success("멤버십이 다시 활성화되었습니다.")):(t.text("멤버십 유지하기").removeClass("btn-cancel").addClass("btn-resume"),e.slideDown(200),l.success("해지 예약이 완료되었습니다.")),a.ajax({url:`/api/v1/subscription/${n}/auto-renewal?autoRenewal=${c}`,type:"PATCH",error:x=>{t.data("status",i),i?(t.text("구독 취소").removeClass("btn-resume").addClass("btn-cancel"),e.slideUp(200)):(t.text("멤버십 유지하기").removeClass("btn-cancel").addClass("btn-resume"),e.slideDown(200)),l.error("처리 실패: "+(x.responseText||"서버 오류"))}})}})})});
