import{j as n}from"../util/alert.min.js";import{S as o}from"../util/toast.min.js";import{C as l}from"../util/confirm.min.js";n(()=>{const m=window.IMP;let t=[];const p=n(".mypage-wrapper").data("portone-id"),u=n("body").data("member-id");p&&m.init(p),f();function f(){n.ajax({url:"/api/v1/payments",type:"GET",success:e=>{t=e.data||[],t.length===0?r():c(t),d(t.length)},error:e=>{console.error("Failed to load payments:",e),r(),d(0)}})}n(document).on("click","#btnRegisterCard",()=>{l.open({title:"결제 수단 등록",desc:"새로운 카드를 등록하시겠습니까? 확인 시 보안 인증창으로 연결됩니다.",actionText:"등록 진행",onConfirm:()=>{const e=crypto.randomUUID();m.request_pay({pg:"tosspayments",pay_method:"card",merchant_uid:`reg_${e}`,customer_uid:`member_${u}_${e}`,name:"결제 수단 등록",amount:0},a=>{if(a.success){const s={billingKey:a.customer_uid,cardName:a.card_name};n.ajax({url:"/api/v1/payments/method",type:"POST",contentType:"application/json",data:JSON.stringify(s),success:i=>{o.success("결제 수단이 안전하게 등록되었습니다."),t||(t=[]),i.data&&t.push(i.data),c(t),d(t.length)},error:()=>o.error("등록에 실패했습니다. 관리자에게 문의하세요.")})}else{let s="인증에 실패했습니다.";a.error_msg&&a.error_msg.includes("CANCELED")&&(s="등록을 취소했습니다."),o.error(s)}})}})}),n(document).on("click",".btn-set-default",function(){const e=n(this).data("id");l.open({title:"기본 카드 설정",desc:"이 카드를 기본 결제 수단으로 설정하시겠습니까?",actionText:"설정",onConfirm:()=>{const a=JSON.parse(JSON.stringify(t));t=t.map(s=>({...s,default:s.id===e})),c(t),n.ajax({url:`/api/v1/payments/method/${e}/default`,type:"PATCH",success:()=>o.success("기본 결제 수단이 변경되었습니다."),error:()=>{o.error("변경에 실패했습니다."),t=a,c(t)}})}})}),n(document).on("click",".btn-delete",function(){const e=n(this).data("id");l.open({title:"결제 수단 삭제",desc:"정말로 삭제하시겠습니까? 삭제 후에는 복구할 수 없습니다.",actionText:"삭제",onConfirm:()=>{const a=JSON.parse(JSON.stringify(t));t=t.filter(s=>s.id!==e),t.length===0?r():c(t),d(t.length),n.ajax({url:`/api/v1/payments/method/${e}`,type:"DELETE",success:()=>o.success("카드가 삭제되었습니다."),error:()=>{o.error("삭제에 실패했습니다."),t=a,t.length===0?r():c(t),d(t.length)}})}})});function c(e){let a='<div class="card-list">';e.forEach(s=>{const i=s.default===!0||s.default===1,y=i?'<span class="badge-default">기본</span>':"",v=i?"active-card":"",b=i?"":`<button type="button" class="btn-text btn-set-default" data-id="${s.id}">기본으로 설정</button>`,h=i?"":`<button type="button" class="btn-text text-danger btn-delete" data-id="${s.id}">삭제</button>`;a+=`
                <div class="saved-card-item ${v}">
                    <div class="card-info-group">
                        <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                        <div class="card-text">
                            <div class="card-name-row">
                                <span class="card-name">${s.cardName}</span>
                                ${y}
                            </div>
                            <span class="card-number">**** **** **** ${s.last4Digit}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        ${b}
                        ${h}
                    </div>
                </div>`}),a+="</div>",n("#payment-list-container").removeClass("empty-state").addClass("payment-list").html(a)}function r(){n("#payment-list-container").removeClass("payment-list").addClass("empty-state").html(`
            <div class="card-status empty">
                <i class="far fa-credit-card" style="font-size: 48px; margin-bottom: 16px; color: #cbd5e1;"></i>
                <p>등록된 결제 수단이 없습니다.</p>
                <p style="font-size: 13px; margin-top:5px;">멤버십 구독을 위해 카드를 등록해주세요.</p>
            </div>
        `)}function d(e){let a="";e<3?a=`<button type="button" id="btnRegisterCard" class="btn btn--secondary" style="width: 100%;">
                        <i class="fas fa-plus"></i> 새 카드 등록하기
                    </button>`:a=`<div class="max-card-alert">
                        <i class="fas fa-info-circle"></i> 결제 수단은 최대 3개까지 등록 가능합니다.
                    </div>`,n("#payment-action-container").html(a)}});
