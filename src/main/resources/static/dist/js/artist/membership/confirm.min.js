import{j as e}from"../../util/alert.min.js";import{S as c}from"../../util/toast.min.js";import{C as S}from"../../util/confirm.min.js";e(()=>{const b=e(".subscription-wrapper"),h=b.data("portone-id"),N=b.data("has-payment")===!0,w=e("body").data("member-id"),i=e("#subscriptionMode").val(),p=e("#isMembershipActive").val()==="true",y=parseInt(e("#finalAmount").val(),10)||0,g=e("#currentSubscriptionId").val(),m=e("#targetMembershipId").val(),u=window.IMP;h&&u&&u.init(h);let d=[];const v=t=>{const a=p?"":"disabled";let s="구독 결제하기",n="btn-confirm";i==="UPGRADE"&&(s="업그레이드 결제하기"),i==="DOWNGRADE"&&(s="멤버십 변경 예약하기",n="btn-confirm btn-secondary"),i==="SAME"&&(s="현재 이용 중인 멤버십",n="btn-confirm btn-disabled"),p||(s="현재 가입할 수 없는 멤버십입니다");const o=`
            <p class="confirmation-notice" style="${i==="SAME"?"display:none;":""}">
                <i class="fas fa-exclamation-circle"></i> 결제/변경 내용을 다시 한번 확인해주세요.
            </p>
            <button type="button" class="${n}" id="btnSubscribe" ${a} ${i==="SAME"||!p?"disabled":""}>
                ${s}
            </button>
        `;e("#action-button-wrapper").html(o)},$=t=>{let a='<div class="payment-dropdown" id="paymentDropdown">';return t.forEach(s=>{const n=s.default===!0||s.isDefault===!0;a+=`
                <div class="payment-option"
                     data-id="${s.id}"
                     data-name="${s.cardName}"
                     data-last4="${s.last4Digit}"
                     data-default="${n}">
                    <div class="card-detail">
                        <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                        <div class="card-text-group">
                            <span class="card-name-txt">
                                ${s.cardName}${n?" (기본)":""}
                            </span>
                            <span class="card-number-txt">
                                **** **** **** ${s.last4Digit}
                            </span>
                        </div>
                    </div>
                </div>
            `}),a+="</div>",a},D=t=>{const a=t.find(x=>x.default===!0||x.isDefault===!0)||t[0],s=t.length>1,n=s?$(t):"",r=s?'<button type="button" class="change-btn">변경 <i class="fas fa-chevron-down"></i></button>':"",o=a.default===!0||a.isDefault===!0,l=`
            <span class="section-label">결제 수단 선택</span>
            <div class="selected-card-box" id="currentPaymentBox">
                <div class="card-detail">
                    <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                    <div class="card-text-group">
                        <span class="card-name-txt" id="selectedCardName">
                            ${a.cardName}${o?" (기본)":""}
                        </span>
                        <span class="card-number-txt" id="selectedCardNum">
                            **** **** **** ${a.last4Digit}
                        </span>
                        <input type="hidden" id="selectedPaymentId" value="${a.id}">
                    </div>
                </div>
                ${r}
            </div>
            ${n}
        `;e("#payment-method-wrapper").html(l),v()},f=()=>{e("#payment-method-wrapper").html(`
            <div class="empty-payment-box">
                <div class="empty-icon"><i class="far fa-credit-card"></i></div>
                <p>등록된 결제 수단이 없습니다.<br>카드를 등록하고 바로 구독을 시작하세요.</p>
                <button type="button" id="btnRegisterNewCard" class="btn-register-direct">
                    <i class="fas fa-plus"></i> 새 카드 등록하기
                </button>
            </div>
        `),e("#action-button-wrapper").empty()},M=()=>{e.ajax({url:"/api/v1/payments",type:"GET",success:t=>{d=t.data||[],d.length===0?f():D(d)},error:()=>{f()}})},P=()=>{const t=new Date;t.setMonth(t.getMonth()+1);const a=t.getFullYear()+"."+String(t.getMonth()+1).padStart(2,"0")+"."+String(t.getDate()).padStart(2,"0");e("#nextBillingDate").text(a)},A=(t,a,s,n)=>{const r=n?" (기본)":"";e("#selectedCardName").text(a+r),e("#selectedCardNum").text("**** **** **** "+s),e("#selectedPaymentId").val(t),e("#paymentDropdown").slideUp(200),e("#currentPaymentBox").find(".change-btn i").removeClass("fa-chevron-up").addClass("fa-chevron-down")},I=(t,a,s)=>{t.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> 예약 중...'),e.ajax({url:`/api/v1/subscription/${a}/downgrade`,type:"PATCH",contentType:"application/json",data:JSON.stringify({nextMembershipId:Number(s)}),success:n=>{c.success("다음 결제일에 등급이 변경됩니다."),setTimeout(()=>location.href="/my-page/subscription",1500)},error:n=>{const r=n.responseJSON;c.error("변경 예약 실패: "+(r?.error?.message||"오류 발생")),t.prop("disabled",!1).text("변경 예약하기")}})},E=(t,a,s,n,r)=>{t.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> 결제 중...'),e.ajax({url:`/api/v1/subscription/${a}/upgrade`,type:"POST",contentType:"application/json",data:JSON.stringify({newMembershipId:Number(s),paymentMethodId:Number(n),amount:r}),success:o=>{c.success("멤버십이 업그레이드 되었습니다!"),setTimeout(()=>location.href=o.data?.redirectUrl||"/artist/success",1e3)},error:o=>{const l=o.responseJSON;c.error("업그레이드 실패: "+(l?.error?.message||"결제 오류")),t.prop("disabled",!1).text("업그레이드 결제하기")}})},T=(t,a,s)=>{t.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> 결제 진행 중...'),e.ajax({url:"/api/v1/subscription",type:"POST",contentType:"application/json",data:JSON.stringify({membershipId:Number(a),paymentMethodId:Number(s)}),success:n=>{c.success("구독이 시작되었습니다! 환영합니다."),setTimeout(()=>location.href=n.data?.redirectUrl||"/",1e3)},error:n=>{const r=n.responseJSON;c.error("구독 처리 실패: "+(r?.error?.message||"결제 오류")),t.prop("disabled",!1).text("구독 결제하기")}})};e(document).on("click","#btnRegisterNewCard",()=>{const t=crypto.randomUUID(),a=`reg_${t}`,s=`member_${w}_${t}`;u.request_pay({pg:"tosspayments",pay_method:"card",merchant_uid:a,customer_uid:s,name:"결제 수단 등록 (구독용)",amount:0},n=>{if(n.success){const r={billingKey:n.customer_uid,cardName:n.card_name};e.ajax({url:"/api/v1/payments/method",type:"POST",contentType:"application/json",data:JSON.stringify(r),success:o=>{c.success("결제 수단이 등록되었습니다."),o.data&&(d=[o.data],D(d))},error:o=>{const l=o.responseJSON;c.error("등록 실패: "+(l?.error?.message||"서버 통신 오류"))}})}else{let r="카드 등록에 실패했습니다.";n.error_msg&&n.error_msg.includes("CANCELED")&&(r="등록을 취소했습니다."),c.error(r)}})}),e(document).on("click","#currentPaymentBox",function(){e(this).find(".change-btn").length>0&&(e("#paymentDropdown").slideToggle(200),e(this).find(".change-btn i").toggleClass("fa-chevron-down fa-chevron-up"))}),e(document).on("click",".payment-option",function(){const t=e(this).data("id"),a=e(this).data("name"),s=e(this).data("last4"),n=e(this).data("default");A(t,a,s,n)}),e(document).on("click","#btnSubscribe",function(){const t=e(this);if(i==="SAME"){c.info("이미 이용 중인 멤버십 등급입니다.");return}if(i==="DOWNGRADE"){S.open({title:"멤버십 변경 예약",desc:"다음 결제일부터 등급이 변경됩니다. 현재 혜택은 결제일까지 유지됩니다. 예약하시겠습니까?",actionText:"변경 예약",onConfirm:()=>I(t,g,m)});return}const a=e("#selectedPaymentId").val();if(!a){c.error("결제 수단을 선택해주세요.");return}const s=i==="UPGRADE"?"멤버십 업그레이드":"구독 결제",n=i==="UPGRADE"?`차액 ${y.toLocaleString()}원이 즉시 결제되며, 바로 혜택이 적용됩니다. 진행하시겠습니까?`:"매월 정기 결제가 시작됩니다. 구독하시겠습니까?";S.open({title:s,desc:n,actionText:"결제하기",onConfirm:()=>{i==="UPGRADE"?E(t,g,m,a,y):T(t,m,a)}})}),i==="NEW"&&P(),i==="DOWNGRADE"||i==="SAME"?v():N?M():f()});
