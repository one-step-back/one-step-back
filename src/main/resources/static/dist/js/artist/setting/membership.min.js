import{j as i}from"../../util/alert.min.js";import{S as c}from"../../util/toast.min.js";import{C as M}from"../../util/confirm.min.js";let u,I,O,$,x,b,d,r={hasAppliedBankAccount:!1,memberships:[]},p=null,y=null,v=!1,o=!1,w=null;const D=()=>{u.html(`
        <div class="account-blocker">
            <div class="account-blocker__icon"><i class="fas fa-university"></i></div>
            <h3>정산 계좌가 등록되지 않았습니다</h3>
            <p>멤버십 기능을 사용하려면 정산 계좌 등록이 필수입니다.</p>
            <button type="button" class="btn btn--primary" id="btn-go-account">계좌 설정하러 가기</button>
        </div>`),i("#btn-go-account").on("click",()=>i('.tab-item[data-tab="account"]').trigger("click"))},P=(t,s)=>{d.html(`<div class="upload-preview" style="background-image:url('${t}'); position:relative; background-size:cover; background-position:center; height:150px; border-radius:8px; margin-top:10px;"><div class="upload-preview-overlay" style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.5); color:white; font-size:12px; padding:4px; text-align:center;">이미지 등록됨</div><button type="button" class="btn-remove-image" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer;"><i class="fas fa-times"></i></button></div>`).show()},T=(t,s)=>{if(i("#input-level").val(t),b.val(""),d.empty().hide(),p=null,y=null,v=!1,s==="EDIT"){o=!0;const e=r.memberships.find(a=>a.levelOrder===t);if(!e)return;if(w=e.id,x.text(`Tier ${t} 멤버십 수정`),i("#input-name").val(e.name),i("#input-price").val(e.price),i("#input-desc").val(e.description),e.subscriberCount>0?(i("#input-price").prop("disabled",!0),i("#price-warning").length===0&&i("#input-price").after('<p id="price-warning" style="color:orange; font-size:12px; margin-top:5px;">활성 구독자가 있어 가격 수정 불가</p>')):(i("#input-price").prop("disabled",!1),i("#price-warning").remove()),e.imagePath){y=e.imageId||null;const a=e.imagePath.startsWith("/")?e.imagePath:`/api/v1/files/${e.imagePath}`;P(a)}$.text("수정 완료")}else o=!1,w=null,x.text(`Tier ${t} 멤버십 생성`),i("#input-name").val(""),i("#input-price").val("").prop("disabled",!1),i("#input-desc").val(""),i("#price-warning").remove(),$.text("생성하기");I.addClass("open")},C=()=>{I.removeClass("open")},j=t=>{const s=r.memberships.find(e=>e.levelOrder===t);if(s){if(s.subscriberCount>0){c.error("활성 구독자가 있어 삭제할 수 없습니다. 비활성화를 이용해주세요.");return}M.open({title:"멤버십 삭제",desc:`Tier ${t} 멤버십을 영구 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`,actionText:"삭제하기",onConfirm:()=>{const e=JSON.parse(JSON.stringify(r.memberships));r.memberships=r.memberships.filter(a=>a.levelOrder!==t),m(r),i.ajax({url:`/api/v1/memberships/${s.id}`,type:"DELETE",success:()=>{c.success("멤버십이 삭제되었습니다.")},error:a=>{const n=a.responseJSON;c.error("삭제 실패: "+(n?.error?.message||"오류가 발생했습니다.")),r.memberships=e,m(r)}})}})}},H=(t,s,e)=>{const a=r.memberships.find(n=>n.levelOrder===t);!a||!a.id||i.ajax({url:`/api/v1/memberships/${a.id}/status`,type:"PATCH",contentType:"application/json",data:JSON.stringify({active:s}),success:()=>{a.active=s,m(r),c.success(`멤버십이 ${s?"활성화":"비활성화"} 되었습니다.`)},error:()=>{c.error("상태 변경에 실패했습니다."),e.prop("checked",!s),m(r)}})},J=()=>{i(".btn-open-modal").on("click",function(){T(i(this).data("level"),"CREATE")}),i(".btn-edit-membership").on("click",function(){T(i(this).data("level"),"EDIT")}),i(".btn-delete-membership").on("click",function(){j(i(this).data("level"))}),i(".btn-toggle-active").on("change",function(){const t=i(this);H(t.data("level"),t.is(":checked"),t)})},N=(t,s)=>{const e=s.find(a=>a.levelOrder===t);if(e){const a=e.imagePath?e.imagePath.startsWith("/")?e.imagePath:`/api/v1/files/${e.imagePath}`:null,n=a?`<div class="card-image" style="background-image:url('${a}');"></div>`:"",g=e.active?"status-active":"status-inactive",f=e.active?"운영 중":"비활성",k=e.active?"checked":"";return`
            <div class="mock-card registered" id="card-level-${t}">
                <div class="card-header-row">
                    <div class="card-badge">Tier ${t}</div>
                    <div class="status-indicator ${g}">● ${f}</div>
                </div>
                ${n}
                <h3 class="card-title">${e.name}</h3>
                <p class="card-price">₩ ${e.price.toLocaleString()} <span>/월</span></p>
                <p class="card-subscriber-count">구독자: <b>${e.subscriberCount||0}명</b></p>
                <p class="card-description">${e.description}</p>
                <div class="card-actions">
                    <label class="switch-wrapper" title="활성/비활성">
                        <input type="checkbox" class="btn-toggle-active" data-level="${t}" ${k}>
                        <span class="slider-round"></span>
                    </label>
                    <button class="btn btn--secondary btn-card-action btn-edit-membership" data-level="${t}">수정</button>
                    <button class="btn btn--outline btn-card-action btn-card-delete btn-delete-membership" data-level="${t}">삭제</button>
                </div>
            </div>`}else return`
            <div class="mock-card empty" id="card-level-${t}">
                <div class="empty-icon">+</div>
                <h3 class="empty-title">Tier ${t}</h3>
                <p class="empty-desc">미설정</p>
                <button class="btn btn--outline btn-open-modal" data-level="${t}">생성하기</button>
            </div>`},m=t=>{if(u.empty(),!t.hasAppliedBankAccount){D();return}let s='<div class="mock-membership-grid">';for(let e=1;e<=3;e++)s+=N(e,t.memberships);s+="</div>",u.html(s),J()},B=()=>{u.html('<div class="loading-spinner"><i class="fas fa-circle-notch fa-spin"></i></div>'),i.ajax({url:"/api/v1/memberships/manage",type:"GET",success:t=>{r=t.data||t,m(r)},error:()=>{u.html('<p style="text-align:center; color:red;">데이터 로드 실패</p>')}})};function F(){u=i("#membership-content-area"),I=i("#membership-modal"),O=i(".btn-close-modal"),$=i("#btn-save-membership"),x=i("#modal-title"),b=i("#input-file"),i("#membership-image-preview").length===0&&b.parent().append('<div id="membership-image-preview" style="margin-top:10px; display:none;"></div>'),d=i("#membership-image-preview"),O.on("click",()=>C()),b.on("change",function(){const t=this.files?.[0];if(!t)return;const s=new FormData;s.append("file",t),d.html('<div class="upload-loading"><i class="fas fa-spinner fa-spin"></i> 업로드 중...</div>').show(),i.ajax({url:"/api/v1/files/upload",type:"POST",data:s,processData:!1,contentType:!1,success:e=>{const a=e.data?.id||e.id;p=a,v=!1;const n=`/api/v1/files/${a}`;P(n)},error:()=>{c.error("이미지 업로드에 실패했습니다."),b.val(""),d.hide(),p=null}})}),d.on("click",".btn-remove-image",()=>{b.val(""),d.empty().hide(),v=!0,p=null}),$.on("click",()=>{const t=parseInt(i("#input-level").val(),10),s=i("#input-name").val();let e=parseInt(i("#input-price").val(),10);const a=i("#input-desc").val();if(o&&i("#input-price").prop("disabled")){const l=r.memberships.find(h=>h.levelOrder===t);l&&(e=l.price)}if(!s||!e||!a){c.error("모든 필수 정보를 입력해주세요.");return}let n={};const g=r.memberships.find(l=>l.levelOrder===t);let f=p?`/api/v1/files/${p}`:!v&&y&&g?g.imagePath:null;o?n={name:s,price:e,description:a,levelOrder:t,currentImageId:y,newImageId:p,deleteImage:v}:n={name:s,price:e,description:a,levelOrder:t,imageId:p};const k=JSON.parse(JSON.stringify(r.memberships));if(o){const l=r.memberships.findIndex(h=>h.levelOrder===t);l!==-1&&(r.memberships[l]={...r.memberships[l],name:s,price:e,description:a,imagePath:f})}else r.memberships.push({id:null,name:s,price:e,description:a,levelOrder:t,imagePath:f,active:!0,subscriberCount:0});C(),m(r);const S=o?`/api/v1/memberships/${w}`:"/api/v1/memberships",E=o?"PUT":"POST";i.ajax({url:S,type:E,contentType:"application/json",data:JSON.stringify(n),success:()=>{B(),c.success(o?"멤버십이 수정되었습니다.":"멤버십이 생성되었습니다.")},error:l=>{const h=l.responseJSON;c.error("저장 실패: "+(h?.error?.message||"오류 발생")),r.memberships=k,m(r),T(t,o?"EDIT":"CREATE")}})})}export{F as i,B as l};
