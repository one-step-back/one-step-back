import{j as t}from"../../util/alert.min.js";import{S as o}from"../../util/toast.min.js";import{C as D}from"../../util/confirm.min.js";t(()=>{const h=t("#fundingId").val(),d=parseInt(t("#amount").val(),10),b=t("#fundingTitle").val(),l=t(".subscription-wrapper"),f=l.data("portone-id"),v=l.data("member-id"),$=l.data("has-payment")===!0,m=window.IMP;f&&m&&m.init(f);let c=[];const w=()=>{const e=`
            <button type="button" class="btn-confirm" id="btnConfirmPayment">
                ${d.toLocaleString()}원 결제하기
            </button>
            <a href="javascript:history.back()" class="btn-cancel">취소</a>
        `;t("#action-button-wrapper").html(e)},x=e=>{let a='<div class="payment-dropdown" id="paymentDropdown">';return e.forEach(n=>{const s=n.default===!0||n.isDefault===!0;a+=`
                <div class="payment-option"
                     data-id="${n.id}"
                     data-name="${n.cardName}"
                     data-last4="${n.last4Digit}"
                     data-default="${s}">
                    <div class="card-detail">
                        <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                        <div class="card-text-group">
                            <span class="card-name-txt">
                                ${n.cardName}${s?" (기본)":""}
                            </span>
                            <span class="card-number-txt">
                                **** **** **** ${n.last4Digit}
                            </span>
                        </div>
                    </div>
                </div>
            `}),a+="</div>",a},y=e=>{const a=e.find(g=>g.default===!0||g.isDefault===!0)||e[0],n=e.length>1,s=n?x(e):"",r=n?'<button type="button" class="change-btn">변경 <i class="fas fa-chevron-down"></i></button>':"",i=a.default===!0||a.isDefault===!0,p=`
            <span class="section-label">결제 수단 선택</span>
            <div class="selected-card-box" id="currentPaymentBox">
                <div class="card-detail">
                    <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                    <div class="card-text-group">
                        <span class="card-name-txt" id="selectedCardName">
                            ${a.cardName}${i?" (기본)":""}
                        </span>
                        <span class="card-number-txt" id="selectedCardNum">
                            **** **** **** ${a.last4Digit}
                        </span>
                        <input type="hidden" id="selectedPaymentId" value="${a.id}">
                    </div>
                </div>
                ${r}
            </div>
            ${s}
        `;t("#payment-method-wrapper").html(p),w()},u=()=>{t("#payment-method-wrapper").html(`
            <div class="empty-payment-box">
                <div class="empty-icon"><i class="far fa-credit-card"></i></div>
                <p>등록된 결제 수단이 없습니다.<br>카드를 등록하고 바로 후원하세요.</p>
                <button type="button" id="btnRegisterNewCard" class="btn-register-direct">
                    <i class="fas fa-plus"></i> 새 카드 등록하기
                </button>
            </div>
        `),t("#action-button-wrapper").empty()},P=()=>{t.ajax({url:"/api/v1/payments",type:"GET",success:e=>{c=e.data||[],c.length===0?u():y(c)},error:()=>{u()}})},C=e=>{const a=t("#btnConfirmPayment");a.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> 결제 진행 중...'),t.ajax({url:`/api/v1/crowd-funding/fund/${h}`,type:"POST",contentType:"application/json",data:JSON.stringify({amount:d,paymentMethodId:e}),success:n=>{o.success("후원이 성공적으로 완료되었습니다!"),setTimeout(()=>{window.location.href=`success?payment-id=${n.data}`},1500)},error:n=>{const s=n.responseJSON;o.error(s?.error?.message||"결제에 실패했습니다."),a.prop("disabled",!1).text(`${d.toLocaleString()}원 결제하기`)}})};t(document).on("click","#btnRegisterNewCard",()=>{const e=crypto.randomUUID(),a=`reg_${e}`,n=`member_${v}_${e}`;m.request_pay({pg:"tosspayments",pay_method:"card",merchant_uid:a,customer_uid:n,name:"결제 수단 등록 (펀딩용)",amount:0},s=>{if(s.success)t.ajax({url:"/api/v1/payments/method",type:"POST",contentType:"application/json",data:JSON.stringify({billingKey:s.customer_uid,cardName:s.card_name}),success:r=>{o.success("결제 수단이 등록되었습니다."),r.data&&(c=[r.data],y(c))},error:r=>{const i=r.responseJSON;o.error("등록 실패: "+(i?.error?.message||"서버 통신 오류"))}});else{let r="카드 등록 취소";s.error_msg&&(r=s.error_msg),o.error(r)}})}),t(document).on("click","#currentPaymentBox",function(e){t(e.currentTarget).find(".change-btn").length>0&&(t("#paymentDropdown").slideToggle(200),t(e.currentTarget).find(".change-btn i").toggleClass("fa-chevron-down fa-chevron-up"))}),t(document).on("click",".payment-option",function(e){const a=t(e.currentTarget),n=a.data("id"),s=a.data("name"),r=a.data("last4"),p=a.data("default")?" (기본)":"";t("#selectedCardName").text(s+p),t("#selectedCardNum").text("**** **** **** "+r),t("#selectedPaymentId").val(n),t("#paymentDropdown").slideUp(200),t("#currentPaymentBox").find(".change-btn i").removeClass("fa-chevron-up").addClass("fa-chevron-down")}),t(document).on("click","#btnConfirmPayment",()=>{const e=t("#selectedPaymentId").val();if(!e){o.error("결제 수단을 선택해주세요.");return}D.open({title:"펀딩 후원",desc:`"${b}" 프로젝트에
${d.toLocaleString()}원을 후원하시겠습니까?`,actionText:"결제하기",onConfirm:()=>{C(parseInt(e,10))}})}),$?P():u()});
