import{j as e}from"../../util/alert.min.js";import{S as a}from"../../util/toast.min.js";e(()=>{const b=e("#file-input"),y=e("#btn-add-media"),w=e("#btn-submit-feed"),E=e('input[name="status"]'),$=e("#tier-selection-area"),l=e("#tier-options-container"),m=e("#form-mode").val(),T=e("#feed-id").val(),O=e("#artist-id").val(),I=parseInt(e("#current-min-tier").val(),10)||0;let u=[],f=[],x=[];const L=()=>{e.ajax({url:"/api/v1/memberships",type:"GET",data:{"artist-id":O},success:r=>{const t=r.data||r;Array.isArray(t)&&(u=t.sort((s,i)=>s.levelOrder-i.levelOrder)),M()},error:r=>{console.error("Membership Load Error:",r),l.html('<div class="empty-text error">멤버십 정보를 불러오지 못했습니다.</div>')}})},M=()=>{if(!u||u.length===0){l.html('<div class="empty-text">등록된 멤버십이 없습니다.</div>');return}l.empty(),u.forEach(r=>{const t=I===r.levelOrder?"checked":"",s=`
                <label class="tier-radio">
                    <input type="radio" name="minTier" value="${r.levelOrder}" ${t}>
                    <div class="tier-card">
                        <span class="tier-name">${r.name}</span>
                        <span class="tier-badge">Lv.${r.levelOrder}</span>
                    </div>
                </label>
            `;l.append(s)})},k=()=>{e('input[name="status"]:checked').val()==="MEMBER_ONLY"?$.addClass("active"):$.removeClass("active")};E.on("change",k),y.on("click",()=>{b.trigger("click")}),b.on("change",r=>{const t=r.target;if(!t.files||t.files.length===0)return;Array.from(t.files).forEach(i=>{S(i)}),e(t).val("")}),e(document).on("click",".btn-remove-existing",function(r){const t=e(r.currentTarget).closest(".media-item"),s=t.data("file-id");s&&x.push(s),t.remove()});const S=r=>{const t=e('<div class="media-item new-file"></div>'),s=e(`
            <div class="progress-overlay">
                <div class="progress-bar-container"><div class="progress-bar"></div></div>
                <span class="progress-text">0%</span>
            </div>
        `);t.append(s),y.before(t);const i=URL.createObjectURL(r),v=r.type.startsWith("video");let o;v?(o=e("<video></video>").attr("src",i).prop("muted",!0).prop("playsinline",!0).css({width:"100%",height:"100%","object-fit":"cover","pointer-events":"none"}),o.on("loadeddata",function(){this.currentTime=.1}),t.append('<div class="media-item__video-icon"><i class="fas fa-play"></i></div>')):o=e("<img>").attr("src",i),t.prepend(o);const p=new FormData;p.append("file",r),e.ajax({url:"/api/v1/files/upload",type:"POST",data:p,processData:!1,contentType:!1,xhr:()=>{const c=new window.XMLHttpRequest;return c.upload.addEventListener("progress",n=>{if(n.lengthComputable){const d=Math.round(n.loaded/n.total*100);s.find(".progress-bar").css("width",d+"%"),s.find(".progress-text").text(d+"%")}},!1),c},success:c=>{const n=c.data?.id||c.id;s.fadeOut(300,function(){e(this).remove()}),t.data("file-id",n),f.push(n);const d=e('<button type="button" class="media-item__remove-btn"><i class="fas fa-times"></i></button>');d.on("click",()=>{t.remove(),f=f.filter(h=>h!==n),URL.revokeObjectURL(i)}),t.append(d)},error:()=>{a.error(`파일 업로드 실패: ${r.name}`),t.remove()}})};w.on("click",function(r){const t=e(r.currentTarget),s=e('select[name="category"]').val(),i=e('input[name="title"]').val().trim(),v=e('textarea[name="content"]').val().trim(),o=e('input[name="status"]:checked').val(),p=e('input[name="minTier"]:checked').val(),c=p?parseInt(p,10):0;if(e(".progress-overlay").length>0){a.error("파일 업로드가 진행 중입니다.");return}if(!s){a.error("카테고리를 선택해주세요."),e('select[name="category"]').trigger("focus");return}if(o==="MEMBER_ONLY"){if(u.length===0){a.error("등록된 멤버십이 없어 전용 글을 작성할 수 없습니다.");return}if(!p){a.error("열람 가능한 최소 멤버십 등급을 선택해주세요."),l.css("border","1px solid red"),setTimeout(()=>l.css("border","none"),2e3);return}}const n=e(".media-item.existing-file").length;if(!v&&f.length===0&&n===0){a.error("내용을 입력하거나 파일을 추가해주세요.");return}const d={id:m==="edit"?T:null,title:i,content:v,category:s,status:o,minTier:c,fileIds:f,deleteFileIds:x},h=m==="edit"?"PUT":"POST",j=m==="edit"?`/api/v1/feeds/${T}`:"/api/v1/feeds";t.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i> 처리 중...'),e.ajax({url:j,type:h,contentType:"application/json",data:JSON.stringify(d),success:g=>{a.success(m==="edit"?"게시물이 수정되었습니다.":"게시물이 등록되었습니다."),setTimeout(()=>{location.href=`/artist/${O}/feed`},1e3)},error:g=>{console.error("Submit Error:",g);const R=g.responseJSON?.error?.message||"요청 처리에 실패했습니다.";a.error(R),t.prop("disabled",!1).text(m==="edit"?"수정하기":"게시하기")}})}),L(),k()});
