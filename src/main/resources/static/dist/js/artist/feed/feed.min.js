import{j as a}from"../../util/alert.min.js";import{S as d}from"../../util/toast.min.js";import{C as x}from"../../util/confirm.min.js";import{i as q}from"./feed-like.min.js";import{t as N}from"../../util/timeUtil.min.js";a(()=>{const i=a("#feed-list"),r=a("#loading-sentinel"),u=r.find(".spinner"),m=i.data("artist-id"),v=a("body").data("member-id");let c=null;const y=10;let l=!0,p=!1;const h=()=>{if(p||!l)return;p=!0,u.addClass("active");const e={artistId:m,size:y};c!==null&&(e.lastFeedId=c),a.ajax({url:"/api/v1/feeds/list",type:"GET",data:e,success:s=>{const t=s.data;if(t){if(t.content&&t.content.length>0)I(t.content),c=t.content[t.content.length-1].id;else if(c===null){i.html(`
                        <div class="feed-empty-state">
                            <i class="far fa-newspaper icon"></i>
                            <p class="message">아직 등록된 피드가 없습니다.</p>
                            <p class="sub-message">아티스트의 새로운 소식을 기다려주세요!</p>
                        </div>
                    `),o&&o.unobserve(r[0]),r.hide();return}l=t.hasNext,l||(o&&o.unobserve(r[0]),r.hide())}},error:s=>{console.error("Error loading feeds:",s),d.error("피드를 불러오는데 실패했습니다.")},complete:()=>{p=!1,u.removeClass("active")}})},o=new IntersectionObserver(e=>{e.forEach(s=>{s.isIntersecting&&l&&h()})},{threshold:.1}),I=e=>{let s="";e.forEach(t=>{const w=t.locked||!1,b=N(t.writeTime),$=t.artistProfilePath||"/images/default-profile.png";if(w){const n=t.requiredMembershipName||"멤버십",k=t.requiredMembershipId,P=k?`/artist/${t.artistId}/membership/${k}/confirm`:`/artist/${t.artistId}/membership`;s+=`
                    <article class="feed-card feed-card--locked" data-feed-id="${t.id}">
                        <div class="card-header">
                            <img src="${$}" alt="프로필" class="profile-img">
                            <div class="profile-info">
                                <span class="nickname">${t.artistNickname}</span>
                                <span class="timestamp">${b}</span>
                            </div>
                            <div class="header-actions">
                                <span class="category-badge"><i class="fas fa-lock"></i> ${n}</span>
                            </div>
                        </div>

                        <div class="card-media" style="height: 200px; background: #eee;"></div>
                        <div class="card-body">
                            <h3 class="card-title">${n} 전용 게시글입니다.</h3>
                            <div class="card-content-text">이 콘텐츠를 확인하려면 <strong>${n}</strong> 구독이 필요합니다.</div>
                        </div>

                        <div class="lock-overlay">
                            <div class="lock-icon-box">
                                <i class="fas fa-lock"></i>
                            </div>
                            <p class="lock-message">이 게시글은 잠겨있습니다</p>
                            <p class="lock-sub-message">${n}에 가입하고 아티스트를 후원하세요.</p>
                            <button type="button" class="btn-subscribe-req" data-url="${P}">
                                ${n} 구독하고 전체 보기
                            </button>
                        </div>
                    </article>
                `;return}let f="";if(t.thumbnailPath){const n=t.fileCount>1?`<div class="multi-files-icon"><i class="fas fa-layer-group"></i> +${t.fileCount-1}</div>`:"";t.mediaType==="VIDEO"?f=`<div class="card-media"><video src="${t.thumbnailPath}" muted loop playsinline></video>${n}</div>`:f=`<div class="card-media"><img src="${t.thumbnailPath}" alt="이미지" loading="lazy">${n}</div>`}const C=t.liked?"active":"",E=t.liked?"fas":"far";let g="";v&&v===t.artistId&&(g=`
                    <div class="more-menu-wrapper">
                        <button type="button" class="action-btn btn-more btn-feed-more"><i class="fas fa-ellipsis-h"></i></button>
                        <div class="dropdown-menu">
                            <a href="/artist/${m}/feed/write?id=${t.id}" class="dropdown-item"><i class="fas fa-pen"></i> 수정</a>
                            <button class="dropdown-item btn-delete" data-feed-id="${t.id}"><i class="fas fa-trash"></i> 삭제</button>
                        </div>
                    </div>`),s+=`
                <article class="feed-card" data-feed-id="${t.id}">
                    <div class="card-header">
                        <img src="${$}" alt="프로필" class="profile-img">
                        <div class="profile-info">
                            <span class="nickname">${t.artistNickname}</span>
                            <span class="timestamp">${b}</span>
                        </div>
                        <div class="header-actions">
                            <span class="category-badge">${t.category}</span>
                            ${g}
                        </div>
                    </div>
                    ${f}
                    <div class="card-body">
                        <h3 class="card-title">${t.title}</h3>
                        <div class="card-content-text">${t.content}</div>
                    </div>
                    <div class="card-footer">
                        <button class="action-btn btn-like ${C}" data-feed-id="${t.id}">
                            <i class="${E} fa-heart icon-heart"></i>
                            <span class="like-count">${t.likeCount}</span>
                        </button>
                        <button class="action-btn">
                            <i class="far fa-comment"></i>
                            <span>${t.replyCount}</span>
                        </button>
                    </div>
                </article>
            `}),i.append(s)};i.on("click",".feed-card",function(e){const s=a(this);if(s.hasClass("feed-card--locked")){d.info("멤버십 구독이 필요한 게시글입니다.");return}if(a(e.target).closest(".action-btn, .profile-info, .more-menu-wrapper, .dropdown-item, .btn-subscribe-req").length)return;const t=s.data("feed-id");location.href=`/artist/${m}/feed/view?id=${t}`}),i.on("click",".btn-subscribe-req",function(e){e.stopPropagation(),e.preventDefault();const s=a(this).data("url");s&&(location.href=s)}),i.on("click",".btn-feed-more",function(e){e.stopPropagation(),a(".more-menu-wrapper").not(a(this).parent()).removeClass("active"),a(this).parent().toggleClass("active")}),a(document).on("click",()=>{a(".more-menu-wrapper").removeClass("active")}),i.on("click",".btn-delete",function(e){e.stopPropagation();const s=a(this).data("feed-id");x.open({title:"게시글 삭제",desc:"정말 이 게시글을 삭제하시겠습니까?",actionText:"삭제",onConfirm:()=>{a.ajax({url:`/api/v1/feeds/${s}`,type:"DELETE",success:()=>{d.success("게시글이 삭제되었습니다."),a(`article[data-feed-id='${s}']`).fadeOut(300,function(){a(this).remove(),i.children("article").length===0&&location.reload()})},error:()=>{d.error("삭제 실패")}})}})}),q(),r.length>0&&o.observe(r[0]),h()});
